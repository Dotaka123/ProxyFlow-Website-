<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>Dashboard</title>
</head>
<body>

<h2>Dashboard</h2>

<select id="pkgSelect" onchange="onPackageChange()">
  <option value="">Choisir package</option>
  <option value="1">Golden</option>
  <option value="2">Silver</option>
</select>

<select id="countrySelect" disabled></select>
<select id="durationSelect" disabled></select>

<button onclick="createProxy()">Créer proxy</button>

<div id="proxyList"></div>

<script>
const API_BASE_URL = "https://bot.mega-panel.net/api/web/index.php/v1";

function getToken(){
  return localStorage.getItem("token");
}

async function apiCall(endpoint, options = {}){
  const token = getToken();
  const res = await fetch(API_BASE_URL + endpoint, {
    method: options.method || "GET",
    headers: {
      "Content-Type": "application/json",
      ...(token ? { "Authorization": "Bearer " + token } : {})
    },
    body: options.body ? JSON.stringify(options.body) : null
  });

  const data = await res.json();
  if(!res.ok) throw data;
  return data;
}

let allPrices = [];

async function init(){
  try {
    allPrices = await apiCall("/prices");   // OK, requires token
    loadProxies();
  } catch(e) {
    alert("Erreur init: " + JSON.stringify(e));
    window.location.href = "login.html";
  }
}

async function onPackageChange(){
  const pkgId = document.getElementById("pkgSelect").value;
  if(!pkgId) return;

  try {
    const countries = await apiCall(`/countries?pkg_id=${pkgId}`);
    const countrySelect = document.getElementById("countrySelect");
    countrySelect.disabled = false;
    countrySelect.innerHTML = countries.map(c => `<option value="${c.id}">${c.country_name}</option>`).join("");

    const pkg = allPrices.find(p => p.package_id == pkgId);
    document.getElementById("durationSelect").disabled = false;
    document.getElementById("durationSelect").innerHTML = pkg.map(d => `<option value="${d.days}">${d.days} days - $${d.price}</option>`).join("");

  } catch(e){
    console.error(e);
    alert("Erreur /countries : " + JSON.stringify(e));
  }
}

async function createProxy(){
  const pkgId = document.getElementById("pkgSelect").value;
  const countryId = document.getElementById("countrySelect").value;
  const duration = document.getElementById("durationSelect").value;

  try {
    const payload = {
      parent_proxy_id: 1, // à remplacer par vrai parent proxy id
      protocol: "http",
      duration: duration
    };
    const res = await apiCall("/proxies", { method: "POST", body: payload });
    alert("Proxy créé ! ID: " + res.id);
    loadProxies();
  } catch(e){
    alert("Erreur création: " + JSON.stringify(e));
  }
}

async function loadProxies(){
  try {
    const list = await apiCall("/all-proxies?offset=0");
    document.getElementById("proxyList").innerHTML = JSON.stringify(list, null, 2);
  } catch(e){
    console.error(e);
  }
}

init();
</script>

</body>
</html>
