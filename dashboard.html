<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Dashboard</title>
    <style>
        body { font-family: sans-serif; background: #f0f2f5; padding: 20px; }
        .card { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); margin-bottom: 20px; }
        .btn { background: #4e73df; color: white; padding: 10px; border: none; cursor: pointer; border-radius: 4px; }
        select { padding: 8px; margin-right: 10px; }
    </style>
</head>
<body>
    <div class="card">
        <h2>Solde : <span id="balance">0.00</span> $</h2>
        <p id="email"></p>
    </div>

    <div class="card">
        <h3>ðŸ›’ Acheter un Proxy</h3>
        <select id="pkgSelect" onchange="loadCountries()">
            <option value="">-- Package --</option>
            <option value="1">Golden (0.70$)</option>
            <option value="2">Silver (0.50$)</option>
        </select>
        <select id="countrySelect" onchange="loadCities()" disabled>
            <option value="">-- Pays --</option>
        </select>
        <select id="citySelect" disabled>
            <option value="">-- Ville --</option>
        </select>
        <select id="protocolSelect">
            <option value="http">HTTP</option>
            <option value="socks5">SOCKS5</option>
        </select>
        <button class="btn" onclick="buy()">Acheter</button>
    </div>

    <div class="card">
        <h3>ðŸ“‹ Mes Proxies</h3>
        <div id="proxyList">Chargement...</div>
    </div>

    <script src="js/config.js"></script>
    <script>
        // Charger les pays
        async function loadCountries() {
            const pkgId = document.getElementById('pkgSelect').value;
            const res = await apiCall(`/api/countries?pkg_id=${pkgId}`);
            const select = document.getElementById('countrySelect');
            select.disabled = false;
            select.innerHTML = '<option value="">-- Pays --</option>' + res.map(c => `<option value="${c.id}">${c.name}</option>`).join('');
        }

        // Charger les villes
        async function loadCities() {
            const pkgId = document.getElementById('pkgSelect').value;
            const countryId = document.getElementById('countrySelect').value;
            const res = await apiCall(`/api/cities?pkg_id=${pkgId}&country_id=${countryId}`);
            const select = document.getElementById('citySelect');
            select.disabled = false;
            select.innerHTML = '<option value="">-- Ville --</option>' + res.map(c => `<option value="${c.id}">${c.name}</option>`).join('');
        }

        // Action d'achat
        async function buy() {
            const body = {
                package_id: document.getElementById('pkgSelect').value,
                country_id: document.getElementById('countrySelect').value,
                city_id: document.getElementById('citySelect').value || 0,
                protocol: document.getElementById('protocolSelect').value
            };
            try {
                await apiCall('/api/create-proxy', { method: 'POST', body: JSON.stringify(body) });
                alert("Achat rÃ©ussi !");
                refresh();
            } catch (e) { alert(e.message); }
        }

        // RafraÃ®chir les donnÃ©es
        async function refresh() {
            const user = await apiCall('/api/auth/me');
            document.getElementById('balance').innerText = user.balance.toFixed(2);
            document.getElementById('email').innerText = user.email;

            const proxies = await apiCall('/api/my-proxies');
            document.getElementById('proxyList').innerHTML = proxies.map(p => `
                <div style="padding:10px; border-bottom:1px solid #eee">
                    <b>${p.protocol}</b> | ${p.username}:${p.password}@${p.host}:${p.port}
                </div>
            `).join('') || "Aucun proxy";
        }

        refresh();
    </script>
</body>
</html>
