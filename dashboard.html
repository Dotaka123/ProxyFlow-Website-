<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Proxy Shop</title>
    <link rel="stylesheet" href="css/style.css">
</head>
<body>
    <div class="header">
        <h1>ğŸŒ Proxy Shop</h1>
        <div class="header-right">
            <span id="userEmailDisplay"></span>
            <div class="balance" id="headerBalanceDisplay">$0.00</div>
            <button class="btn-logout" onclick="logout()" style="background:rgba(255,255,255,0.2); border:none; color:white; padding:8px 15px; border-radius:5px; cursor:pointer;">DÃ©connexion</button>
        </div>
    </div>

    <div class="container">
        <div class="card" style="text-align:center; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color:white;">
            <h2>ğŸ’° Votre Solde</h2>
            <div id="balanceDisplay" style="font-size: 40px; font-weight:bold; margin:15px 0;">$0.00</div>
            <a href="recharge.html" class="btn" style="background:white; color:#667eea; text-decoration:none; display:inline-block;">ğŸ’³ Recharger</a>
        </div>

        <div class="card">
            <h2>ğŸ›’ Acheter un Proxy</h2>
            <form id="buyForm">
                <div class="form-group">
                    <label>Package</label>
                    <select id="packageSelect" required>
                        <option value="">Choisir...</option>
                        <option value="1">Golden Package ($0.25)</option>
                    </select>
                </div>
                <button type="submit" class="btn btn-primary" style="width:100%;">Acheter maintenant</button>
            </form>
        </div>

        <div class="card">
            <h2>ğŸ“‹ Mes Proxies</h2>
            <div id="myProxies">Chargement...</div>
        </div>
    </div>

    <script src="js/config.js"></script>
    <script>
        let userData = JSON.parse(localStorage.getItem('user') || '{}');
        
        function logout() {
            localStorage.clear();
            window.location.href = 'login.html';
        }

        function updateUI() {
            document.getElementById('userEmailDisplay').textContent = userData.email || '';
            const formattedBalance = '$' + (userData.balance || 0).toFixed(2);
            document.getElementById('headerBalanceDisplay').textContent = formattedBalance;
            document.getElementById('balanceDisplay').textContent = formattedBalance;
        }

        document.getElementById('buyForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const pkg = document.getElementById('packageSelect').value;
            
            // VÃ©rification locale du solde pour message flottant immÃ©diat
            if (userData.balance < 0.25) {
                showToast('âŒ Solde insuffisant ! Veuillez recharger votre compte.', 'error');
                return;
            }

            try {
                const res = await apiCall('/api/create-proxy', {
                    method: 'POST',
                    body: { package_id: pkg, protocol: 'http', duration: 1 }
                });
                
                showToast('âœ… Proxy achetÃ© avec succÃ¨s !', 'success');
                userData.balance = res.userBalance;
                localStorage.setItem('user', JSON.stringify(userData));
                updateUI();
                loadProxies();
            } catch (err) {
                // L'erreur est gÃ©rÃ©e par apiCall
            }
        });

        async function loadProxies() {
            try {
                const proxies = await apiCall('/api/my-proxies');
                const container = document.getElementById('myProxies');
                if (proxies.length === 0) {
                    container.innerHTML = '<p style="text-align:center;color:#666;">Aucun proxy actif.</p>';
                    return;
                }
                container.innerHTML = proxies.map(p => `
                    <div class="proxy-item" style="background:#f8f9fa; padding:15px; border-radius:8px; margin-bottom:10px; border-left:4px solid #667eea;">
                        <strong>${p.ip}:${p.port}</strong><br>
                        <small>User: ${p.username} | Pass: ${p.password}</small>
                    </div>
                `).join('');
            } catch (err) { }
        }

        updateUI();
        loadProxies();
    </script>
</body>
</html>
