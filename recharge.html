<!DOCTYPE html>
<html lang="fr" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Recharger - Proxy Shop</title>

    <!-- CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="css/style.css">

    <style>
        .recharge-header {
            background: var(--header-bg);
            color: white;
            padding: 2rem 0;
            margin-bottom: 2rem;
            border-radius: 0 0 2rem 2rem;
        }
        .step-number {
            width: 32px;
            height: 32px;
            background: var(--primary-color);
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            margin-right: 1rem;
        }
        .email-display {
            background: var(--bg-color);
            padding: 1rem;
            border-radius: 0.5rem;
            font-weight: bold;
            color: var(--primary-color);
            font-size: 1.25rem;
            border: 2px dashed var(--primary-color);
        }
    </style>
</head>
<body>

    <header class="recharge-header text-center">
        <div class="container">
            <h1 class="h2 fw-bold mb-2">ðŸ’° <span data-i18n="recharge_btn">Recharger mon compte</span></h1>
            <p class="opacity-75 mb-0" data-i18n="brand_name">Proxy Shop</p>
        </div>
    </header>

    <div class="container pb-5">
        <div class="row justify-content-center">
            <div class="col-lg-8">

                <div class="nav-utils mb-4 justify-content-center">
                    <button class="util-btn" onclick="toggleLang()">
                        <span id="langIcon">ðŸ‡«ðŸ‡·</span>
                    </button>
                    <button class="util-btn" onclick="toggleTheme()">
                        <i id="themeIcon" class="fas fa-moon"></i>
                    </button>
                </div>

                <div class="card p-4 mb-4">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <div>
                            <div class="text-muted small" data-i18n="email_label">Email</div>
                            <div class="fw-bold" id="userEmail">...</div>
                        </div>
                        <div class="text-end">
                            <div class="text-muted small" data-i18n="your_balance">Solde actuel</div>
                            <div class="h4 fw-bold text-primary mb-0">$<span id="userBalance">0.00</span></div>
                        </div>
                    </div>

                    <div class="alert alert-warning border-0 shadow-sm mb-4">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        AprÃ¨s le paiement, la recharge sera validÃ©e manuellement par l'administrateur.
                    </div>

                    <div class="row g-4">
                        <div class="col-md-12">
                            <div class="d-flex align-items-center mb-3">
                                <div class="step-number">1</div>
                                <h3 class="h5 mb-0">Envoyer le paiement</h3>
                            </div>
                            <div class="p-3 bg-light rounded-3 text-center mb-4 border border-light-subtle">
                                <p class="text-muted mb-2">Envoyez le montant souhaitÃ© sur FaucetPay Ã  :</p>
                                <div class="email-display d-inline-block">hugoasmin@gmail.com</div>
                            </div>
                        </div>

                        <div class="col-md-6">
                            <div class="d-flex align-items-center mb-3">
                                <div class="step-number">2</div>
                                <h3 class="h5 mb-0">Username FaucetPay</h3>
                            </div>
                            <input type="text" id="fpUsername" class="form-control py-2" placeholder="Ex: tonnyignace86">
                        </div>

                        <div class="col-md-6">
                            <div class="d-flex align-items-center mb-3">
                                <div class="step-number">3</div>
                                <h3 class="h5 mb-0">Montant ($)</h3>
                            </div>
                            <input type="number" id="amount" class="form-control py-2" step="0.01" min="0.25" placeholder="0.25">
                            <div class="small text-muted mt-1">Minimum: $0.25</div>
                        </div>
                    </div>

                    <button class="btn btn-primary w-100 py-3 mt-4 fw-bold" onclick="submitRecharge()">
                        <i class="fas fa-paper-plane me-2"></i> J'ai effectuÃ© le paiement
                    </button>
                </div>

                <div class="card p-4">
                    <h3 class="h5 mb-4 d-flex align-items-center">
                        <i class="fas fa-history me-2 text-primary"></i> Mon Historique de Recharge
                    </h3>
                    <div id="rechargeHistory">
                        <div class="text-center py-4">
                            <div class="spinner-border text-primary spinner-border-sm"></div>
                        </div>
                    </div>
                </div>

                <div class="text-center mt-4">
                    <a href="dashboard.html" class="text-decoration-none text-muted fw-bold">
                        <i class="fas fa-arrow-left me-1"></i> <span data-i18n="nav_dashboard">Retour au dashboard</span>
                    </a>
                </div>

            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="js/config.js"></script>
    <script src="js/notifications.js"></script>
    <script src="js/theme-lang.js"></script>
    <script>
    const user = JSON.parse(localStorage.getItem('user') || '{}');
    const token = localStorage.getItem('token');

    if (!user.email || !token) {
        window.location.href = 'login.html';
    }

    document.getElementById('userEmail').textContent = user.email;
    document.getElementById('userBalance').textContent = (user.balance || 0).toFixed(2);

    async function submitRecharge() {
        const faucetpayUsername = document.getElementById('fpUsername').value.trim();
        const amount = parseFloat(document.getElementById('amount').value);

        if (!faucetpayUsername || !amount || amount < 0.25) {
            showToast('Remplis correctement le nom FaucetPay et le montant (min 0.25$)', 'error');
            return;
        }

        try {
            await apiCall('/api/recharge-request', {
                method: 'POST',
                body: JSON.stringify({ amount, faucetpayUsername })
            });

            showToast('Demande envoyÃ©e avec succÃ¨s. En attente de validation.', 'success');
            document.getElementById('fpUsername').value = '';
            document.getElementById('amount').value = '';
            await loadRechargeHistory();

        } catch (err) {
            showToast(err.message || 'Erreur lors de lâ€™envoi', 'error');
        }
    }

    async function loadRechargeHistory() {
        const container = document.getElementById('rechargeHistory');
        try {
            const recharges = await apiCall('/api/my-recharges');
            if (!recharges.length) {
                container.innerHTML = '<p class="text-center text-muted py-4">Aucune recharge pour le moment.</p>';
                return;
            }

            let html = '<div class="table-responsive"><table class="table table-hover align-middle">';
            html += '<thead><tr><th>Date</th><th>Montant</th><th>Statut</th></tr></thead><tbody>';

            recharges.forEach(r => {
                let badgeClass = 'bg-info';
                let statusText = 'Attente';
                if (r.status === 'approved') { badgeClass = 'bg-success'; statusText = 'ValidÃ©'; }
                if (r.status === 'rejected') { badgeClass = 'bg-danger'; statusText = 'RejetÃ©'; }

                html += `<tr>
                    <td>${new Date(r.createdAt).toLocaleDateString()}</td>
                    <td class="fw-bold">$${r.amount.toFixed(2)}</td>
                    <td><span class="badge ${badgeClass}">${statusText}</span></td>
                </tr>`;
            });
            html += '</tbody></table></div>';
            container.innerHTML = html;
        } catch (e) {
            container.innerHTML = '<p class="text-danger text-center py-4">Erreur lors du chargement.</p>';
        }
    }

    loadRechargeHistory();
    </script>
    <script src="js/tawk.js"></script>
</body>
</html>
